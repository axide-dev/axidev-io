name: Reusable Build Workflow

on:
  workflow_call:
    inputs:
      matrix-json:
        required: true
        type: string
        description: "JSON array of build configurations. Each object must provide os and arch and may include build-type, build-tests, run-tests, package-output, enable-xvfb, cmake-generator, mingw-version."
      artifact-name-prefix:
        required: false
        type: string
        default: ""
        description: "Prefix for artifact names"

jobs:
  prepare-matrix:
    name: Prepare build matrices
    runs-on: ubuntu-latest
    outputs:
      linux-matrix: ${{ steps.split.outputs.linux-matrix }}
      macos-matrix: ${{ steps.split.outputs.macos-matrix }}
      windows-matrix: ${{ steps.split.outputs.windows-matrix }}
    steps:
      - name: Split matrix by OS
        id: split
        uses: actions/github-script@v7
        env:
          MATRIX_JSON: ${{ inputs.matrix-json }}
        with:
          script: |
            const raw = process.env.MATRIX_JSON;
            let matrix;
            try {
              matrix = JSON.parse(raw);
            } catch (e) {
              core.setFailed(`Invalid inputs.matrix-json: ${e.message}`);
              return;
            }

            if (!Array.isArray(matrix)) {
              core.setFailed('inputs.matrix-json must be a JSON array');
              return;
            }

            const byOsPrefix = (prefix) =>
              matrix.filter((cfg) => typeof cfg?.os === 'string' && cfg.os.startsWith(prefix));

            core.setOutput('linux-matrix', JSON.stringify(byOsPrefix('ubuntu')));
            core.setOutput('macos-matrix', JSON.stringify(byOsPrefix('macos')));
            core.setOutput('windows-matrix', JSON.stringify(byOsPrefix('windows')));

  build-linux:
    name: Build ${{ matrix.arch }} on ${{ matrix.os }}
    needs: prepare-matrix
    if: needs.prepare-matrix.outputs.linux-matrix != '[]'
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include: ${{ fromJson(needs.prepare-matrix.outputs.linux-matrix) }}
    env:
      DISPLAY: ${{ matrix.enable-xvfb && ':99' || '' }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: ${{ matrix.package-output && 0 || 1 }}

      - name: Install dependencies (Linux)
        run: |
          sudo apt-get update
          sudo DEBIAN_FRONTEND=noninteractive apt-get install -y \
            build-essential cmake pkg-config \
            libinput-dev libxkbcommon-dev libudev-dev \
            libx11-dev libxi-dev libxtst-dev \
            libxrandr-dev libxcursor-dev libxinerama-dev
          if [ "${{ matrix.enable-xvfb }}" = "true" ]; then
            sudo apt-get install -y xvfb
            sudo modprobe uinput || true
            sudo chmod 666 /dev/uinput || true
          fi

      - name: Clean stale build directory
        shell: bash
        run: rm -rf build

      - name: Configure (CMake)
        shell: bash
        run: |
          BUILD_TYPE="${{ matrix.build-type || 'Release' }}"
          CMAKE_ARGS="-S . -B build -DCMAKE_BUILD_TYPE=$BUILD_TYPE"

          if [ "${{ matrix.build-tests }}" = "true" ]; then
            CMAKE_ARGS="$CMAKE_ARGS -DAXIDEV_IO_BUILD_TESTS=ON"
          fi

          if [ -n "${{ matrix.cmake-generator }}" ]; then
            CMAKE_ARGS="$CMAKE_ARGS -G \"${{ matrix.cmake-generator }}\""
          fi

          eval cmake $CMAKE_ARGS

      - name: Build (CMake)
        run: cmake --build build --config ${{ matrix.build-type || 'Release' }} --parallel

      - name: Run tests (ctest)
        if: matrix.run-tests
        env:
          CTEST_OUTPUT_ON_FAILURE: 1
        run: ctest --test-dir build --output-on-failure -C ${{ matrix.build-type || 'Release' }}

      - name: Install
        if: matrix.package-output
        run: cmake --install build --prefix dist --config ${{ matrix.build-type || 'Release' }}

      - name: Package (Unix)
        if: matrix.package-output
        shell: bash
        env:
          INPUT_VERSION: ${{ github.event.inputs.version || '' }}
        run: |
          TAG="${INPUT_VERSION:-${GITHUB_REF#refs/tags/}}"
          mkdir -p packages
          tar -C dist -czf "packages/axidev-io-${TAG}-linux-${{ matrix.arch }}.tar.gz" .

      - name: Upload release package
        if: matrix.package-output
        uses: actions/upload-artifact@v4
        with:
          name: ${{ inputs.artifact-name-prefix }}release-package-${{ matrix.os }}-${{ matrix.arch }}
          path: |
            packages/*.tar.gz

  build-macos:
    name: Build ${{ matrix.arch }} on ${{ matrix.os }}
    needs: prepare-matrix
    if: needs.prepare-matrix.outputs.macos-matrix != '[]'
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include: ${{ fromJson(needs.prepare-matrix.outputs.macos-matrix) }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: ${{ matrix.package-output && 0 || 1 }}

      - name: Install dependencies (macOS)
        run: |
          brew update
          brew install cmake

      - name: Clean stale build directory
        shell: bash
        run: rm -rf build

      - name: Configure (CMake)
        shell: bash
        run: |
          BUILD_TYPE="${{ matrix.build-type || 'Release' }}"
          CMAKE_ARGS="-S . -B build -DCMAKE_BUILD_TYPE=$BUILD_TYPE"

          if [ "${{ matrix.build-tests }}" = "true" ]; then
            CMAKE_ARGS="$CMAKE_ARGS -DAXIDEV_IO_BUILD_TESTS=ON"
          fi

          CMAKE_ARGS="$CMAKE_ARGS -DCMAKE_OSX_ARCHITECTURES=${{ matrix.arch }}"
          if [ -n "${{ matrix.cmake-generator }}" ]; then
            CMAKE_ARGS="$CMAKE_ARGS -G \"${{ matrix.cmake-generator }}\""
          fi

          eval cmake $CMAKE_ARGS

      - name: Build (CMake)
        run: cmake --build build --config ${{ matrix.build-type || 'Release' }} --parallel

      - name: Run tests (ctest)
        if: matrix.run-tests
        env:
          CTEST_OUTPUT_ON_FAILURE: 1
        run: ctest --test-dir build --output-on-failure -C ${{ matrix.build-type || 'Release' }}

      - name: Install
        if: matrix.package-output
        run: cmake --install build --prefix dist --config ${{ matrix.build-type || 'Release' }}

      - name: Package (Unix)
        if: matrix.package-output
        shell: bash
        env:
          INPUT_VERSION: ${{ github.event.inputs.version || '' }}
        run: |
          TAG="${INPUT_VERSION:-${GITHUB_REF#refs/tags/}}"
          mkdir -p packages
          tar -C dist -czf "packages/axidev-io-${TAG}-macos-${{ matrix.arch }}.tar.gz" .

      - name: Upload release package
        if: matrix.package-output
        uses: actions/upload-artifact@v4
        with:
          name: ${{ inputs.artifact-name-prefix }}release-package-${{ matrix.os }}-${{ matrix.arch }}
          path: |
            packages/*.tar.gz

  build-windows:
    name: Build ${{ matrix.arch }} on ${{ matrix.os }}
    needs: prepare-matrix
    if: needs.prepare-matrix.outputs.windows-matrix != '[]'
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include: ${{ fromJson(needs.prepare-matrix.outputs.windows-matrix) }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: ${{ matrix.package-output && 0 || 1 }}

      - name: Install MinGW-w64 (Windows)
        uses: egor-tensin/setup-mingw@v2
        with:
          platform: ${{ matrix.arch }}
          static: 0
          version: ${{ matrix.mingw-version || '13.2.0' }}

      - name: Clean stale build directory
        shell: bash
        run: rm -rf build

      - name: Configure (CMake)
        shell: bash
        run: |
          BUILD_TYPE="${{ matrix.build-type || 'Release' }}"
          CMAKE_ARGS="-S . -B build -DCMAKE_BUILD_TYPE=$BUILD_TYPE"
          CMAKE_ARGS="$CMAKE_ARGS -G \"Unix Makefiles\" -DCMAKE_C_COMPILER=gcc -DCMAKE_CXX_COMPILER=g++"

          if [ "${{ matrix.build-tests }}" = "true" ]; then
            CMAKE_ARGS="$CMAKE_ARGS -DAXIDEV_IO_BUILD_TESTS=ON"
          fi

          if [ -n "${{ matrix.cmake-generator }}" ]; then
            CMAKE_ARGS="$CMAKE_ARGS -G \"${{ matrix.cmake-generator }}\""
          fi

          eval cmake $CMAKE_ARGS

      - name: Build (CMake)
        run: cmake --build build --config ${{ matrix.build-type || 'Release' }} --parallel

      - name: Run tests (ctest)
        if: matrix.run-tests
        env:
          CTEST_OUTPUT_ON_FAILURE: 1
        run: ctest --test-dir build --output-on-failure -C ${{ matrix.build-type || 'Release' }}

      - name: Install
        if: matrix.package-output
        run: cmake --install build --prefix dist --config ${{ matrix.build-type || 'Release' }}

      - name: Package (Windows)
        if: matrix.package-output
        shell: pwsh
        env:
          INPUT_VERSION: ${{ github.event.inputs.version || '' }}
        run: |
          $tag = if ($env:INPUT_VERSION) { $env:INPUT_VERSION } else { $env:GITHUB_REF -replace '^refs/tags/', '' }
          New-Item -ItemType Directory -Path packages -Force | Out-Null
          Compress-Archive -Path "dist\*" -DestinationPath "packages/axidev-io-$tag-windows-${{ matrix.arch }}.zip" -Force

      - name: Upload release package
        if: matrix.package-output
        uses: actions/upload-artifact@v4
        with:
          name: ${{ inputs.artifact-name-prefix }}release-package-${{ matrix.os }}-${{ matrix.arch }}
          path: |
            packages/*.zip
