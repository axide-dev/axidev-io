name: Integration tests (manual)

# Manual workflow to run the integration tests. Integration tests are built
# and executed from a dedicated test executable (`axidev-io-integration-tests`)
# and are no longer bundled into the lightweight unit test binary. The
# integration executable is produced when CMake is configured with:
#
#   -DAXIDEV_IO_BUILD_TESTS=ON -DAXIDEV_IO_BUILD_INTEGRATION_TESTS=ON
#
# Integration tests are often interactive and may require GUI/device
# permissions. The workflow exposes a few environment variables useful for
# CI or local runs:
#
# - AXIDEV_IO_RUN_INTEGRATION_TESTS=1  : historically used to enable integration tests
# - AXIDEV_IO_AUTO_CONFIRM=1           : auto-confirm prompts (non-interactive)
# - AXIDEV_IO_INTERACTIVE=(true|yes|1) : enable interactive prompts
#
# By default this workflow sets `AXIDEV_IO_RUN_INTEGRATION_TESTS=1`,
# `AXIDEV_IO_AUTO_CONFIRM=1` and `AXIDEV_IO_INTERACTIVE=1` so the integration
# binaries are built in an interactive-friendly mode. The workflow is intended
# to only build the binaries so they can be run/tested outside of CI.
on:
  workflow_dispatch:
    # no inputs; workflow is always interactive

permissions:
  contents: write

jobs:
  build-ubuntu-x64:
    name: Build integration binaries (Ubuntu x64)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: ./.github/actions/build-linux
        with:
          arch: x64
          build-type: Release
          build-tests: "true"
          build-integration-tests: "true"
          upload-binaries: "true"
          artifact-name: integration-test-binary-ubuntu-latest-x64

  build-ubuntu-arm64:
    name: Build integration binaries (Ubuntu arm64)
    runs-on: ubuntu-24.04-arm
    steps:
      - uses: actions/checkout@v4
      - uses: ./.github/actions/build-linux
        with:
          arch: arm64
          build-type: Release
          build-tests: "true"
          build-integration-tests: "true"
          upload-binaries: "true"
          artifact-name: integration-test-binary-ubuntu-24.04-arm-arm64

  build-macos-arm64:
    name: Build integration binaries (macOS arm64)
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4
      - uses: ./.github/actions/build-macos
        with:
          arch: arm64
          build-type: Release
          build-tests: "true"
          build-integration-tests: "true"
          upload-binaries: "true"
          artifact-name: integration-test-binary-macos-latest-arm64

  build-windows-x64:
    name: Build integration binaries (Windows x64)
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4
      - uses: ./.github/actions/build-windows-mingw
        with:
          arch: x64
          build-type: Release
          build-tests: "true"
          build-integration-tests: "true"
          upload-binaries: "true"
          artifact-name: integration-test-binary-windows-latest-x64

  build-windows-arm64:
    name: Build integration binaries (Windows arm64)
    runs-on: windows-11-arm
    steps:
      - uses: actions/checkout@v4
      - uses: ./.github/actions/build-windows-mingw
        with:
          arch: arm64
          build-type: Release
          build-tests: "true"
          build-integration-tests: "true"
          upload-binaries: "true"
          artifact-name: integration-test-binary-windows-11-arm-arm64

  release:
    name: Create integration test release
    runs-on: ubuntu-latest
    needs:
      - build-ubuntu-x64
      - build-ubuntu-arm64
      - build-macos-arm64
      - build-windows-x64
      - build-windows-arm64
    if: ${{ always() }}
    permissions:
      contents: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download all workflow artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts
        continue-on-error: true

      - name: Prepare release assets
        run: |
          mkdir -p release-assets
          if [ ! -d artifacts ]; then
            echo "No artifacts downloaded; skipping asset collection."
            exit 0
          fi
          while IFS= read -r -d '' file; do
            artifact_dir=$(dirname "$file")
            os_arch=$(basename "$artifact_dir" | sed 's/^integration-test-binary-//' | sed 's/^test-consumer-binary-//')
            if [ -z "$os_arch" ]; then
              os_arch=unknown
            fi
            artifact_name=$(basename "$file")
            ext="${artifact_name##*.}"
            if [ "$ext" = "$artifact_name" ]; then
              base="$artifact_name"
              ext=""
            else
              base="${artifact_name%.*}"
              ext=".$ext"
            fi
            cp "$file" "release-assets/${base}-${os_arch}${ext}"
          done < <(find artifacts -type f \( -name 'axidev-io-integration-tests*' -o -name 'axidev_io_consumer*' -o -name 'axidev-io-test-consumer*' \) ! -name '*.o' ! -name '*.obj' ! -name '*.cmake' -print0)

      - name: Check for release assets
        id: check-assets
        run: |
          if [ -n "$(find release-assets -type f 2>/dev/null)" ]; then
            echo "has_assets=true" >> $GITHUB_OUTPUT
          else
            echo "has_assets=false" >> $GITHUB_OUTPUT
          fi

      - name: Generate release metadata
        if: steps.check-assets.outputs.has_assets == 'true'
        id: release-tag
        run: |
          TAG="integration-tests-$(date +%Y%m%d-%H%M%S)"
          echo "tag=$TAG" >> $GITHUB_OUTPUT
          echo "name=Integration Test Binaries - $TAG" >> $GITHUB_OUTPUT

      - name: Create GitHub release
        if: steps.check-assets.outputs.has_assets == 'true'
        id: create-release
        uses: actions/create-release@v1
        with:
          tag_name: ${{ steps.release-tag.outputs.tag }}
          release_name: ${{ steps.release-tag.outputs.name }}
          body: |
            Manually triggered integration test binaries for various platforms.
          draft: false
          prerelease: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload release assets
        if: steps.check-assets.outputs.has_assets == 'true'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail
          upload_url="${{ steps.create-release.outputs.upload_url }}"
          upload_url="${upload_url%\{*}"
          for asset in release-assets/*; do
            if [ ! -f "$asset" ]; then
              continue
            fi
            name=$(basename "$asset")
            echo "Uploading $name"
            curl -sS -X POST \
              -H "Authorization: token $GITHUB_TOKEN" \
              -H "Content-Type: application/octet-stream" \
              --data-binary @"$asset" \
              "${upload_url}?name=${name}"
          done
