name: Integration tests (manual)

# Manual workflow to run the integration tests. Integration tests are built
# and executed from a dedicated test executable (`axidev-io-integration-tests`)
# and are no longer bundled into the lightweight unit test binary. The
# integration executable is produced when CMake is configured with:
#
#   -DAXIDEV_IO_BUILD_TESTS=ON -DAXIDEV_IO_BUILD_INTEGRATION_TESTS=ON
#
# Integration tests are often interactive and may require GUI/device
# permissions. The workflow exposes a few environment variables useful for
# CI or local runs:
#
# - AXIDEV_IO_RUN_INTEGRATION_TESTS=1  : historically used to enable integration tests
# - AXIDEV_IO_AUTO_CONFIRM=1           : auto-confirm prompts (non-interactive)
# - AXIDEV_IO_INTERACTIVE=(true|yes|1) : enable interactive prompts
#
# By default this workflow sets `AXIDEV_IO_RUN_INTEGRATION_TESTS=1`,
# `AXIDEV_IO_AUTO_CONFIRM=1` and `AXIDEV_IO_INTERACTIVE=1` so the integration
# binaries are built in an interactive-friendly mode. The workflow is intended
# to only build the binaries so they can be run/tested outside of CI.
on:
  workflow_dispatch:
    # no inputs; workflow is always interactive

permissions:
  contents: write

jobs:
  integration-ubuntu-x64:
    name: Integration tests on ubuntu-latest (x86_64)
    uses: ./.github/workflows/build-reusable.yml
    with:
      os: ubuntu-latest
      arch: x64
      build-type: Release
      build-tests: true
      build-integration-tests: true
      enable-xvfb: true
      artifact-name-prefix: ""

  integration-ubuntu-arm64:
    name: Integration tests on ubuntu-24.04-arm (arm64)
    uses: ./.github/workflows/build-reusable.yml
    with:
      os: ubuntu-24.04-arm
      arch: arm64
      build-type: Release
      build-tests: true
      build-integration-tests: true
      enable-xvfb: true
      artifact-name-prefix: ""

  # integration-macos-x64:
  #   name: Integration tests on macos-latest (x86_64)
  #   uses: ./.github/workflows/build-reusable.yml
  #   with:
  #     os: macos-latest
  #     arch: x86_64
  #     build-type: Release
  #     build-tests: true
  #     build-integration-tests: true
  #     artifact-name-prefix: ""

  integration-macos-arm64:
    name: Integration tests on macos-latest (arm64)
    uses: ./.github/workflows/build-reusable.yml
    with:
      os: macos-latest
      arch: arm64
      build-type: Release
      build-tests: true
      build-integration-tests: true
      artifact-name-prefix: ""

  integration-windows-x64:
    name: Integration tests on windows-latest (x86_64)
    uses: ./.github/workflows/build-reusable.yml
    with:
      os: windows-latest
      arch: x64
      build-type: Release
      build-tests: true
      build-integration-tests: true
      artifact-name-prefix: ""

  integration-windows-arm64:
    name: Integration tests on windows-11-arm (arm64)
    uses: ./.github/workflows/build-reusable.yml
    with:
      os: windows-11-arm
      arch: arm64
      build-type: Release
      build-tests: true
      build-integration-tests: true
      mingw-version: "12.2.0"
      artifact-name-prefix: ""

  release:
    name: Create integration test release
    runs-on: ubuntu-latest
    needs:
      - integration-ubuntu-x64
      - integration-ubuntu-arm64
      # - integration-macos-x64
      - integration-macos-arm64
      - integration-windows-x64
      - integration-windows-arm64
    if: ${{ always() }}
    permissions:
      contents: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download all workflow artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts
        continue-on-error: true

      - name: Prepare release assets
        run: |
          mkdir -p release-assets
          # Find all integration test binaries and test-consumer binaries
          find artifacts -type f \( -name 'axidev-io-integration-tests*' -o -name 'axidev_io_consumer*' -o -name 'axidev-io-test-consumer*' \) ! -name '*.o' ! -name '*.obj' -exec cp {} release-assets/ \;
          # Rename binaries to include OS and architecture from their artifact directory names
          cd release-assets
          for file in axidev-io-integration-tests*; do
            if [ -f "$file" ]; then
              # Try to find the original artifact directory name
              artifact_dir=$(find ../artifacts -name "$file" -printf '%h\n' | head -1)
              if [ -n "$artifact_dir" ]; then
                os_arch=$(basename "$artifact_dir" | sed 's/integration-test-binary-//' | sed 's/test-consumer-binary-//')
                ext="${file##*.}"
                if [ "$ext" = "$file" ]; then ext=""; else ext=".$ext"; fi
                base="${file%.*}"
                if [ -n "$ext" ]; then
                  new_name="${base}-${os_arch}${ext}"
                else
                  new_name="${file}-${os_arch}"
                fi
                mv "$file" "$new_name" 2>/dev/null || true
              fi
            fi
          done
          for file in axidev_io_consumer* axidev-io-test-consumer*; do
            if [ -f "$file" ]; then
              artifact_dir=$(find ../artifacts -name "$file" -printf '%h\n' | head -1)
              if [ -n "$artifact_dir" ]; then
                os_arch=$(basename "$artifact_dir" | sed 's/integration-test-binary-//' | sed 's/test-consumer-binary-//')
                ext="${file##*.}"
                if [ "$ext" = "$file" ]; then ext=""; else ext=".$ext"; fi
                base="${file%.*}"
                if [ -n "$ext" ]; then
                  new_name="${base}-${os_arch}${ext}"
                else
                  new_name="${file}-${os_arch}"
                fi
                mv "$file" "$new_name" 2>/dev/null || true
              fi
            fi
          done
          cd ..

      - name: Check for release assets
        id: check-assets
        run: |
          if [ -n "$(find release-assets -type f 2>/dev/null)" ]; then
            echo "has_assets=true" >> $GITHUB_OUTPUT
          else
            echo "has_assets=false" >> $GITHUB_OUTPUT
          fi

      - name: Create GitHub release and upload assets
        if: steps.check-assets.outputs.has_assets == 'true'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          TAG="integration-tests-$(date +%Y%m%d-%H%M%S)"
          gh release create "$TAG" release-assets/* --title "Integration Test Binaries - $TAG" --notes "Manually triggered integration test binaries for various platforms." --prerelease || \
          gh release upload "$TAG" release-assets/* --clobber
